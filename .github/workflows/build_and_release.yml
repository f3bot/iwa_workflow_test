# This workflow builds templates on PRs and creates releases on manual trigger.
name: "Build and Release IWA templates"

on:
  # Triggers build jobs on pull requests to the main branch for validation.
  pull_request:
    branches:
      - main

  # Allows manual triggering of the workflow to create a release.
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  build_vite:
    name: Build Vite Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd vite-iwa-template
          npm install

      - name: Generate private keys and build
        env:
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd vite-iwa-template
          openssl genpkey -algorithm Ed25519 -out private_key.pem
          if [ -z "$KEY_PASSWORD" ]; then
            echo "KEY_PASSWORD Secret is not set."
            exit 1
          fi
          openssl pkcs8 -in private_key.pem -topk8 -out encrypted_key.pem -passout env:KEY_PASSWORD
          echo "PRIVATE_KEY_PATH=encrypted_key.pem" > .env
          echo "PRIVATE_KEY_PASSWORD=$KEY_PASSWORD" >> .env
          echo "NODE_ENV='production'" >> .env
          rm private_key.pem
          npm run build

          rm -r node_modules
          rm -r dist
          rm -r encrypted_key.pem

      - name: Zip project folder
        run: zip -r vite-template.zip ./vite-iwa-template

      - name: Upload Vite artifact
        uses: actions/upload-artifact@v4
        with:
          name: vite-template-artifact
          path: vite-template.zip

  build_webpack:
    name: Build Webpack Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd webpack-iwa-template
          npm install

      - name: Generate private keys and build
        env:
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd webpack-iwa-template
          openssl genpkey -algorithm Ed25519 -out private_key.pem
          if [ -z "$KEY_PASSWORD" ]; then
            echo "KEY_PASSWORD Secret is not set."
            exit 1
          fi
          openssl pkcs8 -in private_key.pem -topk8 -out encrypted_key.pem -passout env:KEY_PASSWORD
          echo "PRIVATE_KEY_PATH=encrypted_key.pem" > .env
          echo "PRIVATE_KEY_PASSWORD=$KEY_PASSWORD" >> .env
          rm private_key.pem
          npm run build

          rm -r node_modules
          rm -r dist
          rm encrypted_key.pem

      - name: Zip project folder
        run: zip -r webpack-template.zip ./webpack-iwa-template

      - name: Upload Webpack artifact
        uses: actions/upload-artifact@v4
        with:
          name: webpack-template-artifact
          path: webpack-template.zip

  create_release:
    name: Create GitHub Release
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [build_vite, build_webpack]
    permissions:
      contents: write
    steps:
      - name: Download Vite artifact
        uses: actions/download-artifact@v4
        with:
          name: vite-template-artifact

      - name: Download Webpack artifact
        uses: actions/download-artifact@v4
        with:
          name: webpack-template-artifact

      - name: Display downloaded files
        run: ls -R

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          # Use the version from the manual input for the tag and release name
          tag: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          artifacts: "vite-template.zip,webpack-template.zip"
          token: ${{ secrets.GITHUB_TOKEN }}